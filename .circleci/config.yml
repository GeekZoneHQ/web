version: 2.1
# orbs:
#   snyk: snyk/snyk@1.2.3
jobs:
  build-test-publish:
    machine:
      image: ubuntu-2004:202107-02 
    steps:
      - checkout  
      - run: 
          name: Skip ci
          command: |
            ./.circleci/skip-ci
      - run: 
          name: Set and persist TAG variable
          background: true 
          command: |
            echo 'export TAG="0.1.${CIRCLE_BUILD_NUM}"' >> /home/circleci/.bashrc
            source /home/circleci/.bashrc
            echo $TAG 
      - run:  
          name: Download and configure Snyk CLI 
          # background: true
          command: |
            curl https://static.snyk.io/cli/latest/snyk-linux -o snyk
            chmod +x ./snyk
            sudo mv ./snyk /usr/local/bin/
            snyk config set disableSuggestions=true
            snyk auth $SNYK_TOKEN
      # - run:
      #     name: Build frontend image 
      #     background: true
      #     command: |
      #       docker build -t geekzone/frontend:0.1.${CIRCLE_BUILD_NUM} -f docker/proxy/Dockerfile .
      # - run:
      #     name: "Build backend image in docker-compose" 
      #     command: |  
      #       docker-compose up -d
      #       docker tag project_web:latest geekzone/backend:0.1.${CIRCLE_BUILD_NUM}
      # - run:
      #     name: Run Testy McTestface tests
      #     command: |
      #       docker-compose run web python3 manage.py test 2>&1 | tee -a test-results/test-output
      # - store_test_results:
      #     path: test-results/test-output
      - run:
          name: Run Snyk scan on frontend image
          background: true
          command: snyk test --docker geekzone/frontend:0.1.2039 --severity-threshold=low --fail-on=all
      - run:
          name: Run Snyk scan on backend image
          background: true
          command: snyk test --docker geekzone/backend:0.1.2039 --severity-threshold=low --fail-on=all
      # - snyk/scan:
      #     docker-image-name: 'geekzone/frontend:0.1.2039'
      #     fail-on-issues: true
      #     project: '${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}-container'
      #     severity-threshold: high
      #     # target-file: docker/proxy/Dockerfile
      #     token-variable: SNYK_TOKEN
      # - snyk/scan:
      #     docker-image-name: 'geekzone/backend:0.1.${CIRCLE_BUILD_NUM}'
      #     fail-on-issues: true
      #     monitor-on-build: true
      #     project: '${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}-container'
      #     severity-threshold: low
      #     target-file: docker/backend/Dockerfile
      #     token-variable: SNYK_TOKEN
      # - deploy:
      #     name: Push frontend image to Docker Hub
      #     background: true
      #     command: |
      #       docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      #       docker push geekzone/frontend:$TAG
      # - deploy:
      #     name: Push backend image to Docker Hub
      #     command: |
      #       docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      #       docker push geekzone/backend:$TAG


workflows:
  version: 2
  main-web:
    jobs:
      - build-test-publish:
          filters:
              branches:
                ignore: 
                - /junk-.*/
          context:
            - org-global
    