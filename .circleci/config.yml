version: 2.1
orbs:
  snyk: snyk/snyk@1.2.3
jobs:
  build-test-publish:
    machine:
      image: ubuntu-2004:202107-02
    steps:
      - checkout  
      - run: 
          name: Skip ci
          command: |
            ./.circleci/skip-ci
      - run:
          name: Build frontend image 
          background: true
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            docker build -t geekzone/frontend:$TAG -f docker/proxy/Dockerfile .
      - run:
          name: "Build backend image in docker-compose" 
          command: |  
            docker-compose up -d
            docker tag project_web:latest geekzone/backend:$TAG
      - run:
          name: Run Testy McTestface tests
          command: |
            docker-compose run web python3 manage.py test 2>&1 | tee -a test-results/test-output
      - store_test_results:
          path: test-results/test-output
      - snyk/scan:
          TAG="0.1.${CIRCLE_BUILD_NUM}"
          docker-image-name: 'geekzone/frontend:${TAG}'
          fail-on-issues: true
          monitor-on-build: true
          project: '${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}-container'
          severity-threshold: low
          target-file: docker/proxy/Dockerfile
          token-variable: SNYK_TOKEN
      - snyk/scan:
          TAG="0.1.${CIRCLE_BUILD_NUM}"
          docker-image-name: 'geekzone/backend:${TAG}'
          fail-on-issues: true
          monitor-on-build: true
          project: '${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}-container'
          severity-threshold: low
          target-file: docker/backend/Dockerfile
          token-variable: SNYK_TOKEN
      - deploy:
          name: Push frontend image to Docker Hub
          background: true
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
            docker push geekzone/frontend:$TAG
      - deploy:
          name: Push backend image to Docker Hub
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
            docker push geekzone/backend:$TAG


workflows:
  version: 2
  main-web:
    jobs:
      - build-test-publish:
          filters:
              branches:
                ignore: 
                - /junk-.*/
          context:
            - org-global
    