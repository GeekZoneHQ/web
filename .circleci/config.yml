version: 2.1
orbs: 
  kubernetes: circleci/kubernetes@0.12.0
jobs:
  scan-build-test-publish:
    machine:
      image: ubuntu-2004:202107-02
    steps:
      - checkout          
      - run:
          name: Prepare Sonar scanner parameters
          command: ./sonar-scripts/sonar_parameters.sh  
      - run:
          name: Download and unzip the SonarScanner
          command: |
            echo "export SONAR_SCANNER_VERSION=4.4.0.2170" >> $BASH_ENV
            source $BASH_ENV
            echo "export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux" >> $BASH_ENV
            source $BASH_ENV
            curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
            unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
            echo "export PATH=$SONAR_SCANNER_HOME/bin:$PATH" >> $BASH_ENV
            source $BASH_ENV
            echo "export SONAR_SCANNER_OPTS='-server'" >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Execute the SonarScanner
          command: |
            sonar-scanner \
            -Dsonar.organization=geekzone \
            -Dsonar.projectKey=geekzone_web \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.python.version=3.9 \
            -Dsonar.login=${SONAR_AUTH_TOKEN}
      - run:
          name: Check quality gate
          command: ./sonar-scripts/sonar_quality_gates.sh
      - run:
          name: Build frontend image 
          background: true
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            docker build -t geekzone/frontend:$TAG -f docker/proxy/Dockerfile .
      - run:
          name: "Build backend image in docker-compose" 
          command: |  
            docker-compose up -d
      - run:
          name: Run Testy McTestface tests
          command: |
            docker-compose run web python3 manage.py test 2>&1 | tee -a test-results/test-output
      - store_test_results:
          path: test-results/test-output
      - deploy:
          name: Push frontend image to Docker Hub
          background: true
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
            docker push geekzone/frontend:$TAG
      - deploy:
          name: Push backend image to Docker Hub
          command: |
            TAG="0.1.${CIRCLE_BUILD_NUM}"
            docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
            docker tag project_web:latest geekzone/backend:$TAG
            docker push geekzone/backend:$TAG

  deploy-prod:
    docker:
      - image: 'cimg/base:stable'
    steps:
      - run:
          name: Install dependencies
          command: |
            sudo apt-get update
            sudo apt install gettext-base moreutils
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
      - run:
          name: Fill out template variables in yaml files
          command: |
            envsubst < k8s/prod-environment/deploy-prod.yaml | sponge k8s/prod-environment/deploy-prod.yaml
      - run:
          name: connect to k8s cluster
          command: |
            aws eks --region $AWS_REGION update-kubeconfig --name $CLUSTER_NAME
      - kubernetes/install-kubectl
      - kubernetes/create-or-update-resource:
          get-rollout-status: true
          resource-file-path: k8s/prod-environment/deploy-prod.yaml
          resource-name: deployment/gz-web
          namespace: prod
          show-kubectl-command: true
      

workflows:
  main:
    jobs:
      - scan-build-test-publish:
          filters:
              branches:
                ignore: 
                - /junk-.*/
                - /doc-.*/
          context:
            - org-global
      - deploy-prod:
          requires:
          - scan-build-test-publish 
          filters:
              branches:
                only: master
          context:
            - org-global
